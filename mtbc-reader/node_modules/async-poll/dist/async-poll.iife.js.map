{"version":3,"file":"async-poll.iife.js","sources":["../src/async-poll.ts"],"sourcesContent":["interface AsyncPollOptions {\n  interval: number;\n  timeout: number;\n}\n\nconst delay = async (t: number) => new Promise(yay => t < 1 ? yay() : setTimeout(yay, t));\n\nexport async function asyncPoll<T>(\n  fn: () => Promise<T>,\n  conditionFn: (d: T) => boolean,\n  options: AsyncPollOptions\n) {\n  const { interval, timeout }: AsyncPollOptions = options || {};\n\n  if (typeof interval !== 'number' || interval < 0) {\n    throw new TypeError(`Expected 'interval' to be a valid number, but received '${interval}'`);\n  }\n\n  if (typeof timeout !== 'number') {\n    throw new TypeError(`Expected 'timeout' to be a valid number, but received '${timeout}'`);\n  }\n\n  try {\n    const perf = window.performance;\n    const itv = +interval;\n    const maxItv = +timeout;\n    const isForever = timeout < 1;\n    let d: T;\n    let op = 0;\n    let ed = 0;\n    let duration = 0;\n    let i = 0;\n    let shouldContinuePolling = false;\n\n    perf.mark('poll starts');\n    do {\n      op = (perf.mark(`poll ${i} starts`), perf.now());\n      d = await fn();\n      ed = (perf.mark(`poll ${i} ends`), perf.now());\n\n      const diff = Math.ceil(ed - op);\n\n      shouldContinuePolling = isForever ? true : duration < maxItv && !conditionFn(d);\n      duration += diff > itv ? diff : itv;\n      perf.measure(`poll ${i} takes`, `poll ${i} starts`, `poll ${i} ends`);\n\n      /** NOTE: Fast return */\n      if (!shouldContinuePolling) break;\n\n      await delay(itv - diff);\n      perf.mark('next poll starts');\n      perf.measure(`poll ${i + 1} starts after`, `poll ${i} ends`, 'next poll starts');\n      i += 1;\n    } while (shouldContinuePolling);\n    perf.mark('poll ends');\n    perf.measure('poll spent', 'poll starts', 'poll ends');\n\n    return d;\n  } catch (e) {\n    throw e;\n  }\n}\n\nexport default asyncPoll;\n"],"names":["delay","t","Promise","yay","setTimeout","asyncPoll","fn","conditionFn","options","interval","_a","timeout","TypeError","perf","window","performance","itv","maxItv","isForever","d","op","ed","duration","i","shouldContinuePolling","mark","now","_b","diff","Math","ceil","measure"],"mappings":"i1CAAA,aAKMA,EAAQ,SAAOC,iEAAc,SAAA,IAAIC,QAAQ,SAAAC,GAAO,OAAAF,EAAI,EAAIE,IAAQC,WAAWD,EAAKF,oBAEhEI,EACpBC,EACAC,EACAC,2HAIA,GAFQC,GAAFC,EAA0CF,GAAW,aAAzCG,YAEM,iBAAbF,GAAyBA,EAAW,EAC7C,MAAM,IAAIG,UAAU,2DAA2DH,OAGjF,GAAuB,iBAAZE,EACT,MAAM,IAAIC,UAAU,0DAA0DD,8CAIxEE,EAAOC,OAAOC,YACdC,GAAOP,EACPQ,GAAUN,EACVO,EAAYP,EAAU,EACxBQ,SACAC,EAAK,EACLC,EAAK,EACLC,EAAW,EACXC,EAAI,EACJC,GAAwB,EAE5BX,EAAKY,KAAK,gCAGJ,OADEZ,EAAKY,KAAK,QAAQF,aAAxBH,EAAqCP,EAAKa,SAChCpB,YAUV,OAVAa,EAAIQ,SACEd,EAAKY,KAAK,QAAQF,WAAxBF,EAAmCR,EAAKa,MAElCE,EAAOC,KAAKC,KAAKT,EAAKD,GAE5BI,IAAwBN,GAAmBI,EAAWL,IAAWV,EAAYY,GAC7EG,GAAYM,EAAOZ,EAAMY,EAAOZ,EAChCH,EAAKkB,QAAQ,QAAQR,WAAW,QAAQA,YAAY,QAAQA,WAGvDC,KAECxB,EAAMgB,EAAMY,iBAAlBD,SACAd,EAAKY,KAAK,oBACVZ,EAAKkB,QAAQ,SAAQR,EAAI,mBAAkB,QAAQA,UAAU,oBAC7DA,GAAK,sBACEC,+BAIT,OAHAX,EAAKY,KAAK,aACVZ,EAAKkB,QAAQ,aAAc,cAAe,gBAEnCZ,UAEP"}